trigger:
- master

parameters:
  - name: build_id_to_deploy
    displayName: Build ID to deploy
    type: string
  
jobs:
  - job: checkvars
    displayName: Check Variables
    steps:
      - task: Bash@3
        condition: not(contains(variables['Build.SourceBranch'], 'refs/tags/'))
        inputs:
          targetType: 'inline'
          script: |
            echo "This pipeline should only be run on git tags"
            fail

      - task: CmdLine@2
        displayName: Check build_id_to_deploy
        condition: eq(${{ parameters.build_id_to_deploy }}, '')
        inputs:
          script: |
            echo build_id_to_deploy was not set
            fail

  - job: dockerrelease
    displayName: Release Docker
    dependsOn: checkvars
    pool:
      vmimage: ubuntu-latest
    strategy:
      matrix:
        kernel:
          repo: kernel
        frontend:
          repo: frontend
        rygg:
          repo: rygg
    steps:
      - task: docker@2
        displayName: log in to perceptilabs
        inputs:
          containerregistry: 'perceptilabs'
          command: 'login'
          addpipelinedata: false

      - task: Docker@2
        displayName: pull from perceptilabs
        inputs:
          containerRegistry: 'perceptilabs'
          repository: $(repo)
          command: 'pull'
          arguments: 'perceptilabs.azurecr.io/$(repo):${{ parameters.build_id_to_deploy }}'
          addPipelineData: false

      - task: Docker@2
        displayName: retag for perceptilabsenterprise
        inputs:
          containerRegistry: 'perceptilabs'
          repository: $(repo)
          command: 'tag'
          arguments: 'perceptilabs.azurecr.io/$(repo):${{ parameters.build_id_to_deploy }} perceptilabsenterprise.azurecr.io/$(repo):$(Build.SourceBranchName)'
          addPipelineData: false

      - task: Docker@2
        displayName: log in to perceptilabsenterprise
        inputs:
          containerRegistry: 'perceptilabsenterprise'
          command: 'login'

      - task: Docker@2
        displayName: push to perceptilabsenterprise
        inputs:
          containerRegistry: 'perceptilabsenterprise'
          repository: '$(repo)'
          command: 'push'
          tags: '$(Build.SourceBranchName)'

  - job: pushfiles
    displayName: Publish files to Azure storage
    dependsOn: checkvars
    pool:
      # has to be on Windows because the AzureFileCopy tasks below only work on windows hosts
      vmImage: windows-latest
    steps:

      - task: DownloadBuildArtifacts@0
        displayName: Download Release Files
        inputs:
          buildType: 'specific'
          project: '54ade330-1468-4064-8c98-7fe751f97330'
          pipeline: '16'
          buildVersionToDownload: 'specific'
          buildId: '${{ parameters.build_id_to_deploy }}'
          downloadType: 'specific'
          itemPattern: |
            **/system_migrations.tar.gz
            **/install_perceptilabs_enterprise
          downloadPath: '$(System.ArtifactsDirectory)'

      - task: Bash@3
        displayName: Set the version in the installer
        inputs:
          targetType: 'inline'
          script: |
            cat install_perceptilabs_enterprise | sed "s/^VERSION=.*$/VERSION=$(Build.SourceBranchName)/g" > temp
            mv temp install_perceptilabs_enterprise
          workingDirectory: '$(System.ArtifactsDirectory)/installation'
          failOnStderr: true

      - task: AzureFileCopy@4
        displayName: publish the installation files to $(Build.SourceBranchName)
        inputs:
          SourcePath: '$(System.ArtifactsDirectory)/installation/**'
          azureSubscription: 'XSP72180|MICROSOFT|XSP72180|XSP524371(d9d6ebad-f86e-4961-9964-5665aa01fcfc)'
          Destination: 'AzureBlob'
          storage: 'perceptilabs'
          ContainerName: 'enterprise'
          BlobPrefix: '$(Build.SourceBranchName)/'

      - task: AzureFileCopy@4
        displayName: publish the installation files to latest
        inputs:
          SourcePath: '$(System.ArtifactsDirectory)/installation/**'
          azureSubscription: 'XSP72180|MICROSOFT|XSP72180|XSP524371(d9d6ebad-f86e-4961-9964-5665aa01fcfc)'
          Destination: 'AzureBlob'
          storage: 'perceptilabs'
          ContainerName: 'enterprise'
          BlobPrefix: 'latest/'
