import pytest
import perceptilabs.auth
import perceptilabs.settings
import jwt.exceptions


TOKEN_CONTENT = """eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI2YWtvOXRBdDFINlBZLXhKUzN0VWs3OXVBSVNqbkFxYjdyVGZYdklGQXBBIn0.eyJleHAiOjE2Mzk0MTkzMzIsImlhdCI6MTYzODgxNDUzMiwiYXV0aF90aW1lIjoxNjM4ODE0NTI5LCJqdGkiOiJiMzY4MTFhMi05ZGMxLTRkODktOWQ2ZS04MWU1MmM4NWQyZTgiLCJpc3MiOiJodHRwczovL2tleWNsb2FrLmRldi5wZXJjZXB0aWxhYnMuY29tOjg0NDMvYXV0aC9yZWFsbXMvdnVlLXBlcmNlcHRpbGFicyIsImF1ZCI6ImFjY291bnQiLCJzdWIiOiI0Yzg3OTczMS01OWQzLTQ4YjQtYjFmNC00ODhmN2FkN2E4MDQiLCJ0eXAiOiJCZWFyZXIiLCJhenAiOiJ2dWUtcGVyY2VwdGlsYWJzLWNsaWVudC1pZCIsIm5vbmNlIjoiODdjNzRiNzctNGM5Yy00OTMyLThjZGItN2ViNzVkMzQ3N2M5Iiwic2Vzc2lvbl9zdGF0ZSI6IjI3ODhmMGU1LTVjMjktNDhiZC1iMzEwLTViZTZlNGI2OGVmNSIsImFjciI6IjEiLCJhbGxvd2VkLW9yaWdpbnMiOlsiaHR0cDovL2xvY2FsaG9zdDo4MDgwIl0sInJlYWxtX2FjY2VzcyI6eyJyb2xlcyI6WyJvZmZsaW5lX2FjY2VzcyIsInVtYV9hdXRob3JpemF0aW9uIl19LCJyZXNvdXJjZV9hY2Nlc3MiOnsiYWNjb3VudCI6eyJyb2xlcyI6WyJtYW5hZ2UtYWNjb3VudCIsIm1hbmFnZS1hY2NvdW50LWxpbmtzIiwidmlldy1wcm9maWxlIl19fSwic2NvcGUiOiJvcGVuaWQgZW1haWwgcHJvZmlsZSIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJmaXJzdCBsb2dpbiI6ZmFsc2UsInByZWZlcnJlZF91c2VybmFtZSI6ImFudG9uLmtAcGVyY2VwdGlsYWJzLmNvbSIsImVtYWlsIjoiYW50b24ua0BwZXJjZXB0aWxhYnMuY29tIn0.fG2nvdRjIuKYt2snGNK-z1OOq0bf4cguwPQUVPztoM9vxXUwibW-Tsy1IWH7jwSypTRLCzbbDQPVN6LqgonBBJar_YbIGpGex-qbli6yrsiRJMGS1fvxA4XfMjNd3cTojercm6PdYDvQ2rBcmjrbJoBXjxWGfN0ygq9vqzY_2UDb5RUlYWbITjddReVtJcDLkDKXo-xoow8jP49vn8KX9c-pBLIhxuPZG4AmNCVOp6_-3f4BoLhrwvKSsr45kOvscfVz2uwTr5QKiYbiHLzb28qax70V144vbIvOmRw1Ny2hOLb3eol8USJBn6JGw6VDjQUPjVCMwn4IPIQGZZ1Zkg"""
CERTS="""{"keys":[{"kid":"6ako9tAt1H6PY-xJS3tUk79uAISjnAqb7rTfXvIFApA","kty":"RSA","alg":"RS256","use":"sig","n":"nJdpUd29WPNe2GJGhg2KpiypMq-GWr2V5XOpWP7dC8IuH9l3jlQfyT_WzJ9PA4Me6vM1AcGhYwNRAjiWVv3wVgqsrFsM-gIcak-XmIg0pOnwpE0mGtQKiofKLeVjWcwiCrLAO7PqyJ1HgMccxq-SMFaHdUgwN3CXOIvrJHGFsmcUSVKDQ6C_bfNsGxrORmQ3ElM3XzDTBe7MvgqXo8RH8mk9TaT8aXr-ymiM-QVER9riepxGUGVOdgPK8T7cY9ubgV7TILBssuTKJhS9lvEXYy-6oU5hPGX6AuA4zlrXKR9l6EpXmlUBse7DUKCBBGU04yGtYpZtIHil-gV5p3qvmQ","e":"AQAB","x5c":["MIICrzCCAZcCBgF0dzA/3DANBgkqhkiG9w0BAQsFADAbMRkwFwYDVQQDDBB2dWUtcGVyY2VwdGlsYWJzMB4XDTIwMDkxMDA4NDMwNFoXDTMwMDkxMDA4NDQ0NFowGzEZMBcGA1UEAwwQdnVlLXBlcmNlcHRpbGFiczCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAJyXaVHdvVjzXthiRoYNiqYsqTKvhlq9leVzqVj+3QvCLh/Zd45UH8k/1syfTwODHurzNQHBoWMDUQI4llb98FYKrKxbDPoCHGpPl5iINKTp8KRNJhrUCoqHyi3lY1nMIgqywDuz6sidR4DHHMavkjBWh3VIMDdwlziL6yRxhbJnFElSg0Ogv23zbBsazkZkNxJTN18w0wXuzL4Kl6PER/JpPU2k/Gl6/spojPkFREfa4nqcRlBlTnYDyvE+3GPbm4Fe0yCwbLLkyiYUvZbxF2MvuqFOYTxl+gLgOM5a1ykfZehKV5pVAbHuw1CggQRlNOMhrWKWbSB4pfoFead6r5kCAwEAATANBgkqhkiG9w0BAQsFAAOCAQEAAFIovS6UK+IRXFDM8SqKkinOdTwutBv9kT2eaudKEymDcs+doXJhH5VCrgIE5EW6xWCDCA1A+iO8HG2AxEHH6xGSvEmWO/2IDoDyIlA8JyY1MwuBhGOcVpX7Jfp/RjJpNcnQ5AuMUWBvvLXou2Zj2U7BLk06mkSApdXZtB/MeOW/aDZ2dn5JP3fnQ2+94f7mPDY15UmN0NvfV0xwESA0o3qE0nqzSz34ZZpAzmKubtdk5Ug8ifxHflq8fJTrLyXFf6SD7tyBkXqABXw0g001aE3t+maEp6H/bbw6eE/DXFinDQkprrOxQmsfViQngihJqKz9kyq4oB9PzvXq/JAddA=="],"x5t":"OMaietVduZ6fqjsY5s0lEpyLqvg","x5t#S256":"TjQ9LcgrzPL4E2Aduaot0g71ovPj0uxBzYzJKKHFlIc"}]}"""

def test_expired_token(monkeypatch):

    monkeypatch.setattr(perceptilabs.auth, 'AUTH_ISSUER', 'testing')
    monkeypatch.setattr(perceptilabs.auth, 'get_certs_from_issuer', lambda : CERTS)

    subject = perceptilabs.auth.jwt_middleware(None)

    environ = {
        'HTTP_AUTHORIZATION': f"bearer {TOKEN_CONTENT}",
    }
    with pytest.raises(jwt.exceptions.ExpiredSignatureError):
        subject(environ, None)

