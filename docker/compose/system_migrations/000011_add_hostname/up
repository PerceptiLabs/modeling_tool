#!/usr/bin/env bash
set -Eeo pipefail

MIGRATIONS_DIR=$(dirname $(dirname $0))
. "${MIGRATIONS_DIR}/common"

install_config(){
  # update the docker-compose file and restart to take the changes
  mydir=$(dirname $0)
  docker-compose rm --stop --force kernel
  customize_docker_compose_file "${mydir}/docker-compose-after.yml"
  cp "${mydir}/docker-compose-after.yml" "${PL_ROOT_DIR}/docker-compose.yml"
  cp "${mydir}/nginx.conf" "${PL_ROOT_DIR}/nginx.conf"
  echo "PL_SERVER_ADDRESS=${PL_SERVER_ADDRESS}" >> .env
}

short_circuit(){
  if [ -f .env ] && grep -q "^PL_SERVER_ADDRESS=" .env;
    echo "The server name has been set"
    exit 0
  fi
}

main(){
  short_circuit
  install_config
}

[ "${BASH_SOURCE[0]}" != "${0}" ] ||
  main
