trigger:
- master
#- dev
- stage




jobs:
### TEST UBUNTU ###

#  - job: test_ubuntu
#    pool:
#        vmImage: "ubuntu-16.04"
#    steps:
#    - bash: |
#        echo "Test in Ubuntu"


### TEST WINDOWS  ###

#  - job: test_windows
#    pool:
#        #win-pool
#        vmImage: "windows-latest"
#    steps:
#    - powershell: |
#        Write-Host "test in windows"  


### TEST OSX  ###

#  - job: test_osx
#    pool:
#        vmImage: "macOS-10.14"
#    steps:
#    - bash: |
#        echo "Test in osx" 


### BUILD UBUNTU ###

#   - job: build_ubuntu
# #    dependsOn:
# #        ["test_ubuntu", "test_windows", "test_osx"] 
#     pool:
#         vmImage: "ubuntu-16.04"
#     steps:
#     - bash: |
#         cd scripts/
#         ./setup_ubuntu.sh
#       displayName: 'Environment setup'
    
#     - bash: |
#         cd scripts/
#         bash -i build_ubuntu.sh
#       displayName: 'Build'
    
#     - publish: $(Build.Repository.LocalPath)/build/frontend_out/
#       artifact: images_ubuntu


### BUILD WINDOWS ###

  - job: build_windows
  #  dependsOn:
  #      ["test_ubuntu", "test_windows", "test_osx"]
    pool:
        #win-pool
        vmImage: "vs2017-win2016"
    # variables:
    #   - group: Windows-build
    steps:
    - task: DownloadSecureFile@1
      name: mySecureFile # The name with which to reference the secure file's path on the agent, like $(mySecureFile.secureFilePath)
      inputs:
        secureFile: 'WindowsCodeSign.pfx' # Not able to reach $(signingCert.secureFilePath) here for some reason

    # - task: PowerShell@2
    #   inputs:
    #     targetType: 'inline'
    #     script: |
    #       Write-Host "Start adding the PFX file to the certificate store."

    #       $pfxpath = '$(mySecureFile.secureFilePath)'
    #       $password = '$(signingCert.password)'
          
    #       Add-Type -AssemblyName System.Security
    #       $cert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2
    #       $cert.Import($pfxpath, $password, [System.Security.Cryptography.X509Certificates.X509KeyStorageFlags]"PersistKeySet")
    #       $store = new-object system.security.cryptography.X509Certificates.X509Store -argumentlist "MY", CurrentUser
    #       $store.Open([System.Security.Cryptography.X509Certificates.OpenFlags]"ReadWrite")
    #       $store.Add($cert)
    #       $store.Close()

    - task: UsePythonVersion@0
      inputs: 
        versionSpec: '3.6'
        architecture: 'x64'
        addToPath: true

    - script: |
        cd scripts/
        ./setup_windows_python.bat
      displayName: 'Environment setup'

    - script: |
        cd scripts/
        ./build_windows.bat
      displayName: 'Build'
    
    - publish: $(Build.Repository.LocalPath)/build/frontend_out/
      artifact: images_windows
    - publish: $(Build.Repository.LocalPath)/build/backend_out/
      artifact: images_windows_core
    


### BUILD OSX ###

#   - job: build_osx
# #    dependsOn:
# #        ["test_ubuntu", "test_windows", "test_osx"]
#     pool:
#         vmImage: "macOS-10.14"
#     variables:
#       - group: OSX-build
#     steps:
#     - task: InstallAppleCertificate@2
#       inputs:
#         certSecureFile: 'devIDapp.p12'
#         certPwd: $(devAppCert.password)
#     - bash: |
#         cd scripts/
#         ./setup_osx.sh
#       displayName: 'Environment setup'

#     - bash: |
#         cd scripts/
#         bash -i build_osx.sh
#       displayName: 'Build'
    
#     - publish: $(Build.Repository.LocalPath)/build/frontend_out/
#       artifact: images_osx
#     - publish: $(Build.Repository.LocalPath)/build/backend_out/
#       artifact: images_osx_core


### PUBLISH SCRIPTS (for deployment purposes)

#   - job: publish_scripts
#     pool:
#         vmImage: "ubuntu-16.04"
# #    dependsOn:
# #      ["build_ubuntu", "test_windows", "test_osx"]
#     steps:
#       - publish: $(Build.Repository.LocalPath)/scripts/
#         artifact: scripts

